<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S&S Family App - 重置密碼</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.4/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.4/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.4/css/ionic.bundle.min.css" />
    <link rel="stylesheet" href="/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      ion-spinner[hidden] {
        display: none !important;
      }
      .error {
        color: var(--ion-color-danger, #ff0000);
        font-size: 12px;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <ion-content class="ion-padding">
        <img src="/assets/family-logo.png" alt="Family Logo" class="family-logo" />
        <ion-card>
          <ion-card-header>
            <ion-card-title>重置密碼</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <form id="reset-password-form">
              <ion-list>
                <ion-item>
                  <ion-input
                    id="new-password"
                    name="newPassword"
                    type="password"
                    label="新密碼"
                    required
                    clear-input
                    minlength="6"
                  ></ion-input>
                  <div id="new-password-error" class="error" hidden>密碼必須至少6個字符</div>
                  <ion-icon id="togglePassword" name="eye-outline" slot="end"></ion-icon>
                </ion-item>
              </ion-list>
              <ion-button id="reset-button" expand="block" type="submit">
                提交
                <ion-spinner name="crescent" hidden></ion-spinner>
              </ion-button>
              <p class="ion-text-center">
                返回 <a href="/login.html">登錄</a>
              </p>
            </form>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </ion-app>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded for reset-password.html");
        console.log("Ionic version:", window.Ionic?.version || "Not loaded");

        const resetForm = document.getElementById("reset-password-form");
        const newPasswordInput = document.getElementById("new-password");
        const togglePassword = document.getElementById("togglePassword");
        const resetButton = document.getElementById("reset-button");
        const newPasswordError = document.getElementById("new-password-error");
        let isSubmitting = false;

        // 動態 API URL
        const API_BASE_URL = window.location.hostname === 'www.mysandshome.com'
          ? 'https://www.mysandshome.com'
          : 'http://localhost:8100';

        // 從 URL 獲取 token
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        console.log("Token from URL:", { tokenLength: token?.length });

        // 初始化錯誤訊息和按鈕狀態
        newPasswordError.hidden = true;
        resetButton.disabled = false;
        console.log("Initial state:", { newPasswordError: newPasswordError.hidden, resetButtonDisabled: resetButton.disabled });

        // Toast 顯示輔助函數
        async function showToast(message, duration, color) {
          console.log(`Showing toast: ${message}`);
          try {
            const toast = document.createElement("ion-toast");
            toast.message = message;
            toast.duration = duration;
            toast.color = color;
            document.body.appendChild(toast);
            await toast.present();
            await toast.onDidDismiss();
            console.log(`Toast dismissed: ${message}`);
          } catch (error) {
            console.error("Toast error:", error);
            alert(message); // 後備方案
          }
        }

        // 輸入驗證
        newPasswordInput?.addEventListener("ionInput", (e) => {
          const value = e.target.value?.trim() || "";
          newPasswordError.hidden = value.length >= 6;
          console.log("New password input:", { value, length: value.length, valid: newPasswordError.hidden });
          updateButtonState();
        });

        // 更新按鈕狀態
        function updateButtonState() {
          const newPasswordValid = newPasswordInput.value.trim().length >= 6;
          resetButton.disabled = !newPasswordValid;
          console.log("Button state updated:", { newPasswordValid, disabled: resetButton.disabled });
        }

        // 切換密碼可見性
        togglePassword?.addEventListener("click", () => {
          const type = newPasswordInput.type === "password" ? "text" : "password";
          newPasswordInput.type = type;
          togglePassword.name = type === "password" ? "eye-outline" : "eye-off-outline";
          console.log("Toggled password visibility:", { type });
        });

        // 表單提交
        resetForm?.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (isSubmitting) {
            console.log("Form submission blocked: Already submitting");
            return;
          }

          console.log("Form submission started");
          isSubmitting = true;
          const newPassword = newPasswordInput.value.trim();

          if (!token) {
            console.log("Validation failed: Token missing");
            await showToast("無效的密碼重置連結", 2000, "danger");
            isSubmitting = false;
            return;
          }

          if (!newPassword || newPassword.length < 6) {
            console.log("Validation failed: Invalid password");
            await showToast("密碼必須至少6個字符", 2000, "danger");
            isSubmitting = false;
            return;
          }

          resetButton.disabled = true;
          const spinner = resetButton.querySelector("ion-spinner");
          spinner.hidden = false;
          console.log("Spinner shown");

          try {
            const resetUrl = `${API_BASE_URL}/reset-password`;
            console.log("Sending reset request to:", resetUrl);
            const response = await fetch(resetUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, newPassword }),
            });

            console.log("Response received:", {
              status: response.status,
              statusText: response.statusText,
              ok: response.ok,
            });

            const data = await response.json();
            console.log("Response data:", data);

            if (!data.success) {
              throw new Error(data.error || "Password reset failed");
            }

            await showToast("密碼重置成功，請重新登錄", 2000, "success");
            console.log("Redirecting to /login.html");
            window.location.href = "/login.html";
          } catch (error) {
            console.error("Reset password error:", { message: error.message, stack: error.stack });
            await showToast(`密碼重置失敗：${error.message}`, 2000, "danger");
          } finally {
            console.log("Finalizing reset attempt");
            isSubmitting = false;
            resetButton.disabled = false;
            spinner.hidden = true;
            setTimeout(() => {
              if (!spinner.hidden) {
                console.warn("Spinner still visible, forcing hide");
                spinner.hidden = true;
                spinner.style.display = 'none';
              }
            }, 100);
          }
        });
      });
    </script>
  </body>
</html>