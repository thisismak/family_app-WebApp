<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>S&S Family App - 忘記密碼</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.4/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.4/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@7.8.4/css/ionic.bundle.min.css" />
    <link rel="stylesheet" href="/styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      ion-spinner[hidden] {
        display: none !important;
      }
      .error {
        color: var(--ion-color-danger, #ff0000);
        font-size: 12px;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <ion-app>
      <ion-content class="ion-padding">
        <img src="/assets/family-logo.png" alt="Family Logo" class="family-logo" />
        <ion-card>
          <ion-card-header>
            <ion-card-title>忘記密碼</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <form id="forgot-password-form">
              <ion-list>
                <ion-item>
                  <ion-input
                    id="email"
                    name="email"
                    type="email"
                    label="電子郵件"
                    required
                    clear-input
                  ></ion-input>
                  <div id="email-error" class="error" hidden>請輸入有效的電子郵件地址</div>
                </ion-item>
              </ion-list>
              <ion-button id="submit-button" expand="block" type="submit">
                提交
                <ion-spinner name="crescent" hidden></ion-spinner>
              </ion-button>
              <p class="ion-text-center">
                返回 <a href="/login.html">登錄</a>
              </p>
            </form>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </ion-app>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM loaded for forgot-password.html");
        console.log("Ionic version:", window.Ionic?.version || "Not loaded");

        const forgotForm = document.getElementById("forgot-password-form");
        const emailInput = document.getElementById("email");
        const submitButton = document.getElementById("submit-button");
        const emailError = document.getElementById("email-error");
        let isSubmitting = false;

        // 動態 API URL
        const API_BASE_URL = window.location.hostname === 'www.mysandshome.com'
          ? 'https://www.mysandshome.com'
          : 'http://localhost:8100';

        // 初始化錯誤訊息和按鈕狀態
        emailError.hidden = true;
        submitButton.disabled = false;
        console.log("Initial state:", { emailError: emailError.hidden, submitButtonDisabled: submitButton.disabled });

        // Toast 顯示輔助函數
        async function showToast(message, duration, color) {
          console.log(`Showing toast: ${message}`);
          try {
            const toast = document.createElement("ion-toast");
            toast.message = message;
            toast.duration = duration;
            toast.color = color;
            document.body.appendChild(toast);
            await toast.present();
            await toast.onDidDismiss();
            console.log(`Toast dismissed: ${message}`);
          } catch (error) {
            console.error("Toast error:", error);
            alert(message);
          }
        }

        // 輸入驗證
        emailInput?.addEventListener("ionInput", (e) => {
          const value = e.target.value?.trim() || "";
          const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
          emailError.hidden = isValidEmail;
          console.log("Email input:", { value, valid: isValidEmail });
          updateButtonState();
        });

        // 更新按鈕狀態
        function updateButtonState() {
          const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim());
          submitButton.disabled = !emailValid;
          console.log("Button state updated:", { emailValid, disabled: submitButton.disabled });
        }

        // 表單提交
        forgotForm?.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (isSubmitting) {
            console.log("Form submission blocked: Already submitting");
            return;
          }

          console.log("Form submission started");
          isSubmitting = true;
          const email = emailInput.value.trim();

          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            console.log("Validation failed: Invalid email");
            await showToast("請輸入有效的電子郵件地址", 2000, "danger");
            isSubmitting = false;
            return;
          }

          submitButton.disabled = true;
          const spinner = submitButton.querySelector("ion-spinner");
          spinner.hidden = false;
          console.log("Spinner shown");

          try {
            const forgotUrl = `${API_BASE_URL}/forgot-password`;
            console.log("Sending forgot password request to:", forgotUrl);
            const response = await fetch(forgotUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });

            console.log("Response received:", {
              status: response.status,
              statusText: response.statusText,
              ok: response.ok,
            });

            const data = await response.json();
            console.log("Response data:", data);

            if (!data.success) {
              throw new Error(data.error || "Failed to send reset link");
            }

            await showToast("密碼重置連結已發送到您的郵箱", 2000, "success");
            console.log("Redirecting to /login.html");
            setTimeout(() => {
              window.location.href = "/login.html";
            }, 2000);
          } catch (error) {
            console.error("Forgot password error:", { message: error.message, stack: error.stack });
            await showToast(`發送重置連結失敗：${error.message}`, 2000, "danger");
          } finally {
            console.log("Finalizing forgot password attempt");
            isSubmitting = false;
            submitButton.disabled = false;
            spinner.hidden = true;
            setTimeout(() => {
              if (!spinner.hidden) {
                console.warn("Spinner still visible, forcing hide");
                spinner.hidden = true;
                spinner.style.display = 'none';
              }
            }, 100);
          }
        });
      });
    </script>
  </body>
</html>